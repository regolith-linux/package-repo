
## Introduction

This repo provides two functions: 
1. A package builder using GitHub workflows to update the repositories when changes are available.  
2. A package repository that uses GitHub Pages to provide HTTP access to the built packages.

It can be considered a general-purpose system for building and hosting packages for Debian-based systems.

## Terms

* `distro` - A global-level name referring to a Linux distribution (eg: `debian`, `slack`)
* `codename` - The name of a given release of a distro (eg: `focal`, `bullseye`)
* `arch` - The system architecture of target machines (eg: `amd64`, `arm64`)
* `stage` - May be one of `unstable`, `testing`, `release`. Modeled from [Debian releases](https://www.debian.org/releases/).
* `repository` - A collection of packages for a given `distro`+`codename`+`arch`+`stage`
* `manifest` - A file containing lists of built package sets of: `<package name> <source ref> <commit id>`

## Package Variants Supported
* Debian


### Package Builder

#### Overview

Package building starts from a root model which specifies the upstream package repositories and source locations.  This package model specifies the following attributes per package:

```json
"package-name": {
  "source": "https://...git",
  "branch": "..."
}
```

The builder traverses the package model and generates a manifest for each package.  This manifest is used to determine what (if anything) has been updated upstream and needs to be built.  The package manifest is a text file with one package per line.  The line contains:

```
package-name branch commit-ref
```

The manifest is generated by simply retrieving the git ref of the upstream repo at the specified branch.  After a manifest is generated, it is compared to the previously generated manifest (stored in the repo).  If there is no differences than the build is complete (NOP).  In the case there are changes, the new manifest is committed along with the newly built packages.

For the case that changes are found, for each package that has changed is built and the results are committed to the repo.

#### Praxis

An "abstract" [GitHub workflow](https://github.com/regolith-linux/package-repo/blob/master/.github/workflows/build-pkg-workflow.yml) implements the abstract execution of manifest generation, diff checking, package building, and committing those changes back to the repo.  The workflow delegates to discrete, independent actions ([manifest generation](https://github.com/kgilmer/build-model-manifest-action), [Debian package building](https://github.com/kgilmer/ingest-debian-reprepro-action)) to perform the package-specific logic. This is done with the hopes that additional package formats may be added in the future.  

The abstract workflow is then used in concrete build scripts ([example](https://github.com/regolith-linux/package-repo/blob/master/.github/workflows/build-testing-debian-bullseye-arm64.yml)) that are particular to a given target OS, package format, stage, etc..

##### Customization

Package builds can be customized in a few ways.  Customization is specified at the `/distro/<stage>/<distro-name>/<codename>/` level.  There are two forms of customization: module mutation and build host mutation.  In the former, a JSON file may be specified that becomes merged with the general package model before manifest generation.  This merging allows for: 

1. Additional packages to be specified for a given `stage`/`distro`/`codename`.
2. Existing packages to specify an alternate source (git url, branch, commit ref).
3. Remove a package from the general model.  This is useful when a given distro already supplies a dependency natively.

For build host mutation, if the file `setup.sh` ([example](distros/release/debian/bullseye/setup.sh)) is present in the directory it is executed on the docker build host before manifest merging begins.

##### Repo Layout

|Path   |Description   |
|---|---|
| `/stages` | General package model per `stage` |
| `/distros` | Distribution specific configuration and model |
| `/docs` | The HTTP root of the package archive, hosted by GitHub Pages |
| `/.github/workflows` | The build system.  Start at build-pkg-workflow.yml |

### HOWTO

#### Implement a Package Builder

Copy the [Debian Reprero action](https://github.com/kgilmer/ingest-debian-reprepro-action) and modify the shell script to call whatever package build commands are needed.  This new action, once staged as a GitHub Action, can then be referenced by a variant of the primary [GitHub workflow](https://github.com/regolith-linux/package-repo/blob/master/.github/workflows/build-pkg-workflow.yml).